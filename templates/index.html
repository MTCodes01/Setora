<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setora - Smart Workout Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --bg: #f9fafb;
            --card: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }

        [data-theme="dark"] {
            --bg: #111827;
            --card: #1f2937;
            --text: #f9fafb;
            --text-light: #9ca3af;
            --border: #374151;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: var(--card);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background 0.3s;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            list-style: none;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--primary);
        }

        .theme-toggle {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--bg);
        }

        /* Auth Pages */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-card {
            background: var(--card);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-light);
        }

        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .error-message {
            background: #fee;
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Main Content */
        main {
            padding: 2rem 0;
            min-height: calc(100vh - 200px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: background 0.3s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-full {
            width: 100%;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        select.form-control {
            cursor: pointer;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        /* Dashboard Stats */
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        /* Exercise List */
        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
        }

        .exercise-details {
            flex: 1;
        }

        .exercise-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .exercise-stats {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Calendar */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .calendar-day:hover {
            background: var(--bg);
        }

        .calendar-day.has-workout {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calendar-day.today {
            border: 2px solid var(--secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            margin: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        /* Workout Entry */
        .workout-entry {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .workout-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                gap: 1rem;
                font-size: 0.875rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .calendar {
                gap: 0.25rem;
            }

            .modal-content {
                padding: 1.5rem;
                margin: 1rem;
            }
        }

        .success-message {
            background: var(--secondary);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Auth Pages -->
    <div id="auth-section" class="hidden">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>üí™ Setora</h1>
                    <p id="auth-subtitle">Track your fitness journey</p>
                </div>

                <div id="error-msg" class="error-message"></div>

                <!-- Login Form -->
                <div id="login-form">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" class="form-control" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="handleLogin()">Log In</button>
                    <div class="auth-toggle">
                        Don't have an account? <a href="#" onclick="toggleAuthForm()">Sign up</a>
                    </div>
                </div>

                <!-- Signup Form -->
                <div id="signup-form" class="hidden">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="signup-name" class="form-control" placeholder="Your Name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signup-email" class="form-control" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signup-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="handleSignup()">Sign Up</button>
                    <div class="auth-toggle">
                        Already have an account? <a href="#" onclick="toggleAuthForm()">Log in</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-section" class="hidden">
        <header>
            <nav class="container">
                <div class="logo">üí™ Setora</div>
                <ul class="nav-links">
                    <li><a href="#" data-page="home" class="active">Home</a></li>
                    <li><a href="#" data-page="add-workout">Add Workout</a></li>
                    <li><a href="#" data-page="calendar">Calendar</a></li>
                    <li><a href="#" data-page="progress">Progress</a></li>
                    <li><a href="#" data-page="profile">Profile</a></li>
                    <li>
                        <button class="theme-toggle" onclick="toggleTheme()" id="theme-icon">üåô</button>
                    </li>
                    <li><a href="#" onclick="handleLogout()">Logout</a></li>
                </ul>
            </nav>
        </header>

        <main class="container">
            <!-- Home Page -->
            <div id="home" class="page active">
                <h1 style="margin-bottom: 1.5rem;">Dashboard</h1>
                
                <div class="grid grid-3 card">
                    <div class="stat-card">
                        <div class="stat-value" id="total-workouts">0</div>
                        <div class="stat-label">Total Workouts</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary), #059669);">
                        <div class="stat-value" id="this-week">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <div class="stat-value" id="current-streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Today's Workout</h2>
                        <button class="btn btn-primary" onclick="navigateTo('add-workout')">+ Add Workout</button>
                    </div>
                    <div id="today-workout">
                        <p class="loading">No workout logged for today. Start tracking!</p>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Recent Workouts</h2>
                    <div id="recent-workouts"></div>
                </div>
            </div>

            <!-- Add Workout Page -->
            <div id="add-workout" class="page">
                <h1 style="margin-bottom: 1.5rem;">Add Workout</h1>
                
                <div class="card">
                    <div id="success-msg" class="success-message"></div>
                    
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" id="workout-date" class="form-control">
                    </div>

                    <div class="form-group">
                        <label>Exercises</label>
                        <div id="exercises-list"></div>
                        <button class="btn btn-outline" onclick="addExerciseEntry()" style="margin-top: 1rem;">+ Add Exercise</button>
                    </div>

                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="workout-notes" class="form-control" rows="3" placeholder="How did it feel? Any notes..."></textarea>
                    </div>

                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="saveWorkout()">Save Workout</button>
                        <button class="btn btn-outline" onclick="saveAsTemplate()">Save as Template</button>
                    </div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendar" class="page">
                <h1 style="margin-bottom: 1.5rem;">Workout Calendar</h1>
                
                <div class="card">
                    <div class="card-header">
                        <button class="btn btn-outline" onclick="changeMonth(-1)">‚Üê Previous</button>
                        <h2 id="calendar-month" class="card-title">November 2024</h2>
                        <button class="btn btn-outline" onclick="changeMonth(1)">Next ‚Üí</button>
                    </div>
                    <div class="calendar" id="calendar-grid"></div>
                </div>
            </div>

            <!-- Progress Page -->
            <div id="progress" class="page">
                <h1 style="margin-bottom: 1.5rem;">Progress Tracking</h1>
                
                <div class="card">
                    <h2 class="card-title">Body Weight Trend</h2>
                    <div class="chart-container">
                        <canvas id="weight-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Workout Volume</h2>
                    <div class="chart-container">
                        <canvas id="volume-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Category Frequency</h2>
                    <div class="chart-container">
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile" class="page">
                <h1 style="margin-bottom: 1.5rem;">Profile Settings</h1>
                
                <div class="card">
                    <h2 class="card-title">Personal Information</h2>
                    
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="profile-name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" id="profile-age" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="profile-gender" class="form-control">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unit Preference</label>
                            <select id="profile-units" class="form-control">
                                <option value="kg">Metric (kg/cm)</option>
                                <option value="lb">Imperial (lb/in)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Height (cm)</label>
                            <input type="number" id="profile-height" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Current Weight (kg)</label>
                            <input type="number" step="0.1" id="profile-weight" class="form-control">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Goal</label>
                        <textarea id="profile-goal" class="form-control" rows="3" placeholder="e.g., Lose 5kg in 3 months, Build muscle..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                </div>

                <div class="card">
                    <h2 class="card-title">Log Weight</h2>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="weight-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Weight (kg)</label>
                            <input type="number" step="0.1" id="weight-value" class="form-control">
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="logWeight()">Log Weight</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Workout Detail Modal -->
    <div id="workout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-date">Workout Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let exercisesData = [];
        let workoutsData = [];
        let currentMonth = new Date();
        let exerciseCounter = 0;
        let currentUser = null;

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            // Save to user profile if logged in
            if (currentUser) {
                apiCall('/user', 'PUT', {...currentUser, theme_preference: newTheme});
            }
        }

        function updateThemeIcon(theme) {
            document.getElementById('theme-icon').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            await checkAuth();
        });

        // Auth Functions
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
            
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showApp();
                
                    // Apply user's theme preference
                    if (data.user.theme_preference) {
                        document.documentElement.setAttribute('data-theme', data.user.theme_preference);
                        localStorage.setItem('theme', data.user.theme_preference);
                        updateThemeIcon(data.user.theme_preference);
                    }
                
                    await loadExercises();
                    await loadDashboard();
                    setupNavigation();
                    document.getElementById('workout-date').valueAsDate = new Date();
                    document.getElementById('weight-date').valueAsDate = new Date();
                } else {
                    showAuth();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
        }

        function toggleAuthForm() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
            document.getElementById('error-msg').classList.remove('show');
        }

        function showError(message) {
            const el = document.getElementById('error-msg');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            try {
                console.log('Attempting login...');
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({email, password})
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    console.log('Login successful, saving token...');
                    localStorage.setItem('session_token', data.token);
                    await checkAuth();
                } else {
                    showError(data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please try again.');
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (!name || !email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/signup`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, email, password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('session_token', data.token);
                    await checkAuth();
                } else {
                    showError(data.error || 'Signup failed');
                }
            } catch (error) {
                showError('Signup failed. Please try again.');
            }
        }

        async function handleLogout() {
            try {
                const token = localStorage.getItem('session_token');
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                localStorage.removeItem('session_token');
                currentUser = null;
                showAuth();
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(e.target.dataset.page);
                });
            });
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            
            document.getElementById(page).classList.add('active');
            const pageLink = document.querySelector(`[data-page="${page}"]`);
            if (pageLink) pageLink.classList.add('active');
            
            if (page === 'calendar') loadCalendar();
            if (page === 'progress') loadProgress();
        }

        // API Calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'credentials': 'include',
                }
            };
            if (data) options.body = JSON.stringify(data);
            
            const response = await fetch(`${API_BASE}${endpoint}`, options);
            
            if (response.status === 401) {
                localStorage.removeItem('session_token');
                showAuth();
                return null;
            }
            
            return response.json();
        }

        // Load Data
        async function loadExercises() {
            exercisesData = await apiCall('/exercises');
        }

        async function loadDashboard() {
            workoutsData = await apiCall('/workouts');
            
            if (!workoutsData) return;
            
            // Stats
            document.getElementById('total-workouts').textContent = workoutsData.length;
            
            const today = new Date().toISOString().split('T')[0];
            const thisWeekStart = new Date();
            thisWeekStart.setDate(thisWeekStart.getDate() - 7);
            
            const thisWeek = workoutsData.filter(w => new Date(w.date) >= thisWeekStart).length;
            document.getElementById('this-week').textContent = thisWeek;
            
            // Streak
            let streak = 0;
            const sortedDates = [...new Set(workoutsData.map(w => w.date))].sort().reverse();
            let checkDate = new Date();
            for (let date of sortedDates) {
                const workoutDate = new Date(date);
                const diff = Math.floor((checkDate - workoutDate) / (1000 * 60 * 60 * 24));
                if (diff <= 1) {
                    streak++;
                    checkDate = workoutDate;
                } else {
                    break;
                }
            }
            document.getElementById('current-streak').textContent = streak;
            
            // Today's workout
            const todayWorkout = workoutsData.find(w => w.date === today);
            if (todayWorkout) {
                displayTodayWorkout(todayWorkout);
            }
            
            // Recent workouts
            displayRecentWorkouts(workoutsData.slice(0, 5));
        }

        function displayTodayWorkout(workout) {
            const html = `
                <div class="exercise-item">
                    <div class="exercise-details">
                        <div class="exercise-name">${workout.day_type}</div>
                        <div class="exercise-stats">${workout.exercises.length} exercises completed</div>
                    </div>
                    <span class="category-badge">${workout.day_type}</span>
                </div>
            `;
            document.getElementById('today-workout').innerHTML = html;
        }

        function displayRecentWorkouts(workouts) {
            if (!workouts || workouts.length === 0) {
                document.getElementById('recent-workouts').innerHTML = '<p class="loading">No workouts yet. Start tracking!</p>';
                return;
            }
            
            const html = workouts.map(w => `
                <div class="exercise-item" onclick="showWorkoutDetails('${w.date}')">
                    <div class="exercise-details">
                        <div class="exercise-name">${new Date(w.date).toLocaleDateString()}</div>
                        <div class="exercise-stats">${w.day_type} ‚Ä¢ ${w.exercises.length} exercises</div>
                    </div>
                    <span class="category-badge">${w.day_type}</span>
                </div>
            `).join('');
            
            document.getElementById('recent-workouts').innerHTML = html;
        }

        // Add Workout
        function addExerciseEntry() {
            exerciseCounter++;
            const html = `
                <div class="workout-entry" id="entry-${exerciseCounter}">
                    <div class="workout-entry-header">
                        <select class="form-control" id="exercise-${exerciseCounter}" onchange="updateExerciseFields(${exerciseCounter})">
                            <option value="">Select Exercise</option>
                            ${exercisesData.map(e => `<option value="${e.id}" data-category="${e.category}">${e.name} (${e.category})</option>`).join('')}
                        </select>
                        <button class="remove-btn" onclick="removeEntry(${exerciseCounter})">Remove</button>
                    </div>
                    <div class="input-row">
                        <div class="form-group">
                            <label>Sets</label>
                            <input type="number" id="sets-${exerciseCounter}" class="form-control" placeholder="3">
                        </div>
                        <div class="form-group">
                            <label>Reps</label>
                            <input type="number" id="reps-${exerciseCounter}" class="form-control" placeholder="10">
                        </div>
                        <div class="form-group">
                            <label>Weight (kg)</label>
                            <input type="number" step="0.5" id="weight-${exerciseCounter}" class="form-control" placeholder="50">
                        </div>
                        <div class="form-group" style="display:none;" id="duration-group-${exerciseCounter}">
                            <label>Duration (min)</label>
                            <input type="number" id="duration-${exerciseCounter}" class="form-control" placeholder="20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="notes-${exerciseCounter}" class="form-control" placeholder="Optional notes...">
                    </div>
                </div>
            `;
            document.getElementById('exercises-list').insertAdjacentHTML('beforeend', html);
        }

        function updateExerciseFields(id) {
            const select = document.getElementById(`exercise-${id}`);
            const category = select.options[select.selectedIndex]?.dataset.category;
            
            if (category === 'Cardio') {
                document.getElementById(`duration-group-${id}`).style.display = 'block';
                document.getElementById(`weight-${id}`).value = '';
                document.getElementById(`weight-${id}`).disabled = true;
            } else {
                document.getElementById(`duration-group-${id}`).style.display = 'none';
                document.getElementById(`duration-${id}`).value = '';
                document.getElementById(`weight-${id}`).disabled = false;
            }
        }

        function removeEntry(id) {
            document.getElementById(`entry-${id}`).remove();
        }

        async function saveWorkout() {
            const date = document.getElementById('workout-date').value;
            const notes = document.getElementById('workout-notes').value;
            
            const exercises = [];
            for (let i = 1; i <= exerciseCounter; i++) {
                const exerciseId = document.getElementById(`exercise-${i}`)?.value;
                if (exerciseId) {
                    exercises.push({
                        exercise_id: parseInt(exerciseId),
                        sets: parseInt(document.getElementById(`sets-${i}`).value) || 0,
                        reps: parseInt(document.getElementById(`reps-${i}`).value) || 0,
                        weight: parseFloat(document.getElementById(`weight-${i}`).value) || 0,
                        duration: parseFloat(document.getElementById(`duration-${i}`).value) || null,
                        notes: document.getElementById(`notes-${i}`).value
                    });
                }
            }
            
            if (exercises.length === 0) {
                alert('Please add at least one exercise');
                return;
            }
            
            const result = await apiCall('/workouts', 'POST', {date, notes, exercises});
            
            if (result && result.success) {
                showSuccess('Workout saved successfully!');
                document.getElementById('exercises-list').innerHTML = '';
                document.getElementById('workout-notes').value = '';
                exerciseCounter = 0;
                await loadDashboard();
            }
        }

        function showSuccess(message) {
            const el = document.getElementById('success-msg');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // Calendar
        async function loadCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('calendar-month').textContent = 
                currentMonth.toLocaleDateString('en-US', {month: 'long', year: 'numeric'});
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div style="text-align:center;font-weight:600;padding:0.5rem;">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day" style="opacity:0.3;"></div>';
            }
            
            const today = new Date().toISOString().split('T')[0];
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const hasWorkout = workoutsData.some(w => w.date === dateStr);
                const isToday = dateStr === today;
                
                html += `<div class="calendar-day ${hasWorkout ? 'has-workout' : ''} ${isToday ? 'today' : ''}" 
                         onclick="showWorkoutDetails('${dateStr}')">${day}</div>`;
            }
            
            document.getElementById('calendar-grid').innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            loadCalendar();
        }

        function showWorkoutDetails(date) {
            const workout = workoutsData.find(w => w.date === date);
            
            if (!workout) {
                document.getElementById('modal-date').textContent = new Date(date).toLocaleDateString();
                document.getElementById('modal-body').innerHTML = '<p>No workout logged for this day.</p>';
            } else {
                document.getElementById('modal-date').textContent = 
                    `${new Date(date).toLocaleDateString()} - ${workout.day_type}`;
                
                const exercisesHtml = workout.exercises.map(ex => `
                    <div class="exercise-item">
                        <div class="exercise-details">
                            <div class="exercise-name">${ex.name}</div>
                            <div class="exercise-stats">
                                ${ex.sets ? `${ex.sets} sets` : ''} 
                                ${ex.reps ? `√ó ${ex.reps} reps` : ''} 
                                ${ex.weight ? `√ó ${ex.weight}kg` : ''}
                                ${ex.duration ? `${ex.duration} min` : ''}
                                ${ex.notes ? `<br><i>${ex.notes}</i>` : ''}
                            </div>
                        </div>
                        <span class="category-badge">${ex.category}</span>
                    </div>
                `).join('');
                
                document.getElementById('modal-body').innerHTML = exercisesHtml + 
                    (workout.notes ? `<p style="margin-top:1rem;"><strong>Notes:</strong> ${workout.notes}</p>` : '');
            }
            
            document.getElementById('workout-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('workout-modal').classList.remove('active');
        }

        // Progress Charts
        async function loadProgress() {
            const weightLogs = await apiCall('/weight');
            const progressData = await apiCall('/progress');
            
            if (!weightLogs || !progressData) return;
            
            // Weight Chart
            const weightCtx = document.getElementById('weight-chart').getContext('2d');
            new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: weightLogs.reverse().map(w => new Date(w.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Body Weight (kg)',
                        data: weightLogs.map(w => w.weight),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            // Volume Chart
            const volumeData = progressData.workout_stats.reduce((acc, stat) => {
                if (!acc[stat.date]) acc[stat.date] = 0;
                acc[stat.date] += stat.volume || 0;
                return acc;
            }, {});
            
            const volumeCtx = document.getElementById('volume-chart').getContext('2d');
            new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(volumeData).map(d => new Date(d).toLocaleDateString()),
                    datasets: [{
                        label: 'Total Volume (kg)',
                        data: Object.values(volumeData),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    }
                }
            });
            
            // Category Frequency Chart
            const categoryCtx = document.getElementById('category-chart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: progressData.category_frequency.map(c => c.category),
                    datasets: [{
                        data: progressData.category_frequency.map(c => c.frequency),
                        backgroundColor: [
                            '#6366f1', '#10b981', '#f59e0b', '#ef4444', 
                            '#8b5cf6', '#ec4899', '#06b6d4'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Profile Management
        async function saveProfile() {
            const data = {
                name: document.getElementById('profile-name').value,
                age: parseInt(document.getElementById('profile-age').value),
                gender: document.getElementById('profile-gender').value,
                height: parseFloat(document.getElementById('profile-height').value),
                weight: parseFloat(document.getElementById('profile-weight').value),
                goal: document.getElementById('profile-goal').value,
                unit_preference: document.getElementById('profile-units').value,
                theme_preference: document.documentElement.getAttribute('data-theme')
            };
            
            await apiCall('/user', 'PUT', data);
            alert('Profile updated successfully!');
        }

        async function logWeight() {
            const date = document.getElementById('weight-date').value;
            const weight = parseFloat(document.getElementById('weight-value').value);
            
            if (!weight) {
                alert('Please enter a weight');
                return;
            }
            
            await apiCall('/weight', 'POST', {date, weight});
            alert('Weight logged successfully!');
            document.getElementById('weight-value').value = '';
        }

        // Templates
        async function saveAsTemplate() {
            const exercises = [];
            for (let i = 1; i <= exerciseCounter; i++) {
                const exerciseId = document.getElementById(`exercise-${i}`)?.value;
                if (exerciseId) {
                    exercises.push({
                        exercise_id: parseInt(exerciseId),
                        sets: parseInt(document.getElementById(`sets-${i}`).value) || 0,
                        reps: parseInt(document.getElementById(`reps-${i}`).value) || 0,
                        weight: parseFloat(document.getElementById(`weight-${i}`).value) || 0
                    });
                }
            }
            
            if (exercises.length === 0) {
                alert('Please add at least one exercise');
                return;
            }
            
            const name = prompt('Enter template name:');
            if (name) {
                await apiCall('/templates', 'POST', {name, exercises});
                alert('Template saved successfully!');
            }
        }

        // Close modal on outside click
        document.getElementById('workout-modal').addEventListener('click', (e) => {
            if (e.target.id === 'workout-modal') {
                closeModal();
            }
        });

        // Enter key handlers for auth forms
        document.getElementById('login-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        
        document.getElementById('signup-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSignup();
        });
    </script>
</body>
</html>