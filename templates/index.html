<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setora - Smart Workout Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --bg: #f9fafb;
            --card: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
        }

        [data-theme="dark"] {
            --bg: #111827;
            --card: #1f2937;
            --text: #f9fafb;
            --text-light: #9ca3af;
            --border: #374151;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            background: var(--card);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background 0.3s;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            list-style: none;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover, .nav-links a.active {
            color: var(--primary);
        }

        .theme-toggle {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .theme-toggle:hover {
            background: var(--bg);
        }

        /* Auth Pages */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .auth-card {
            background: var(--card);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header h1 {
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--text-light);
        }

        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .error-message {
            background: #fee;
            color: var(--danger);
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Main Content */
        main {
            padding: 2rem 0;
            min-height: calc(100vh - 200px);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            transition: background 0.3s;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-full {
            width: 100%;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg);
            color: var(--text);
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        select.form-control {
            cursor: pointer;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        /* Dashboard Stats */
        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        /* Exercise List */
        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
        }

        .exercise-details {
            flex: 1;
        }

        .exercise-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .exercise-stats {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Calendar */
        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .calendar-day:hover {
            background: var(--bg);
        }

        .calendar-day.has-workout {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .calendar-day.today {
            border: 2px solid var(--secondary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card);
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 2rem;
            margin: 2rem;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
        }

        /* Workout Entry */
        .workout-entry {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .workout-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.5rem;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-light);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                gap: 1rem;
                font-size: 0.875rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .calendar {
                gap: 0.25rem;
            }

            .modal-content {
                padding: 1.5rem;
                margin: 1rem;
            }
        }

        .success-message {
            background: var(--secondary);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        /* Rest Day Toggle */
        .rest-day-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .rest-day-toggle:hover {
            background: var(--border);
        }

        .rest-day-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .rest-day-mode {
            text-align: center;
            padding: 3rem 2rem;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border-radius: 12px;
            margin: 1.5rem 0;
        }

        .rest-day-mode h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        /* Exercise Selection Modal */
        .exercise-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            overflow-y: auto;
        }

        .exercise-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .exercise-modal-content {
            background: var(--card);
            border-radius: 12px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .exercise-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .exercise-search {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--bg);
            color: var(--text);
            margin-bottom: 1rem;
        }

        .exercise-filters {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .filter-pill {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.875rem;
        }

        .filter-pill:hover {
            background: var(--bg);
        }

        .filter-pill.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .custom-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .exercise-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 1.5rem;
        }

        .exercise-list-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .exercise-list-item:hover {
            background: var(--bg);
            border-color: var(--primary);
        }

        .exercise-list-item.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .exercise-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .exercise-icon {
            font-size: 1.5rem;
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-info-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .exercise-info-details {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .exercise-list-item.selected .exercise-info-details {
            opacity: 1;
        }

        .exercise-modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 1rem;
            justify-content: space-between;
        }

        /* Create Custom Exercise Form */
        .custom-exercise-form {
            display: none;
            padding: 1.5rem;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .custom-exercise-form.active {
            display: block;
        }

        /* Selected Exercises Display */
        .selected-exercises-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .exercise-card {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .exercise-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            cursor: pointer;
        }

        .exercise-card-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .exercise-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .exercise-card-body {
            padding: 1rem;
        }

        /* Dynamic Sets Editor */
        .sets-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .set-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 0.5rem;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .set-number {
            font-weight: 600;
            color: var(--text-light);
            min-width: 50px;
        }

        .set-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .set-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .set-input-group label {
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .set-input-group input {
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--card);
            color: var(--text);
        }

        .set-input-group input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .remove-set-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-set-btn {
            width: 100%;
            padding: 0.75rem;
            background: transparent;
            border: 2px dashed var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .add-set-btn:hover {
            background: var(--bg);
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Rest Day Badge in Calendar */
        .calendar-day.rest-day {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border-color: #8b5cf6;
        }

        /* Merge Indicator */
        .merge-indicator {
            background: #f59e0b;
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .set-row {
                grid-template-columns: 1fr;
            }

            .set-number {
                text-align: left;
            }

            .exercise-modal-content {
                max-height: 95vh;
            }

            .exercise-filters {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Pages -->
    <div id="auth-section" class="hidden">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>üí™ Setora</h1>
                    <p id="auth-subtitle">Track your fitness journey</p>
                </div>

                <div id="error-msg" class="error-message"></div>

                <!-- Login Form -->
                <div id="login-form">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" class="form-control" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="handleLogin()">Log In</button>
                    <div class="auth-toggle">
                        Don't have an account? <a href="#" onclick="toggleAuthForm()">Sign up</a>
                    </div>
                </div>

                <!-- Signup Form -->
                <div id="signup-form" class="hidden">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="signup-name" class="form-control" placeholder="Your Name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signup-email" class="form-control" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signup-password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                    </div>
                    <button class="btn btn-primary btn-full" onclick="handleSignup()">Sign Up</button>
                    <div class="auth-toggle">
                        Already have an account? <a href="#" onclick="toggleAuthForm()">Log in</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-section" class="hidden">
        <header>
            <nav class="container">
                <div class="logo">üí™ Setora</div>
                <ul class="nav-links">
                    <li><a href="#" data-page="home" class="active">Home</a></li>
                    <li><a href="#" data-page="add-workout">Add Workout</a></li>
                    <li><a href="#" data-page="calendar">Calendar</a></li>
                    <li><a href="#" data-page="progress">Progress</a></li>
                    <li><a href="#" data-page="profile">Profile</a></li>
                    <li>
                        <button class="theme-toggle" onclick="toggleTheme()" id="theme-icon">üåô</button>
                    </li>
                    <li><a href="#" onclick="handleLogout()">Logout</a></li>
                </ul>
            </nav>
        </header>

        <main class="container">
            <!-- Home Page -->
            <div id="home" class="page active">
                <h1 style="margin-bottom: 1.5rem;">Dashboard</h1>
                
                <div class="grid grid-3 card">
                    <div class="stat-card">
                        <div class="stat-value" id="total-workouts">0</div>
                        <div class="stat-label">Total Workouts</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, var(--secondary), #059669);">
                        <div class="stat-value" id="this-week">0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <div class="stat-value" id="current-streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Today's Workout</h2>
                        <button class="btn btn-primary" onclick="navigateTo('add-workout')">+ Add Workout</button>
                    </div>
                    <div id="today-workout">
                        <p class="loading">No workout logged for today. Start tracking!</p>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Recent Workouts</h2>
                    <div id="recent-workouts"></div>
                </div>
            </div>

            <!-- Add Workout Page -->
            <div id="add-workout" class="page">
                <h1 style="margin-bottom: 1.5rem;">Add Workout</h1>

                <div class="card">
                    <div id="success-msg" class="success-message"></div>
                    <div id="merge-indicator" class="merge-indicator" style="display: none;">
                        ‚ö° Adding exercises to existing workout for this date
                    </div>

                    <!-- Date & Rest Day Toggle (improved layout) -->
                    <div class="grid grid-2" style="align-items: center; gap: 1rem;">
                        <div class="form-group">
                            <label for="workout-date">Date</label>
                            <input type="date" id="workout-date" class="form-control"
                                   onchange="checkExistingWorkout()" aria-label="Workout date">
                            <div style="color:var(--text-light); font-size:0.875rem; margin-top:0.5rem;">
                                Select the date for this entry
                            </div>
                        </div>

                        <div class="form-group" style="display:flex; flex-direction:column; justify-content:center;">
                            <div style="display:flex; align-items:center; gap:0.75rem;">

                                <label class="rest-day-toggle" style="margin:0; padding:10px; display:flex; align-items:center; justify-content:center;">
                                    <input type="checkbox" id="rest-day-toggle" onchange="toggleRestDayMode()" aria-label="Mark as rest day" style="margin-right:0.5rem;">
                                    <span>Mark as Rest Day</span>
                                </label>
                            </div>
                        </div>
                    </div>
                
                    <!-- Rest Day Mode -->
                    <div id="rest-day-mode" class="rest-day-mode" style="display: none;">
                        <h3>üõå Rest Day</h3>
                        <p>Recovery is just as important as training!</p>
                    </div>
                
                    <!-- Workout Mode -->
                    <div id="workout-mode">
                        <!-- Selected Exercises -->
                        <div class="form-group">
                            <label>Exercises</label>
                            <div id="selected-exercises" class="selected-exercises-container">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üí™</div>
                                    <p>No exercises added yet</p>
                                    <p style="font-size: 0.875rem;">Click "Add Exercises" to get started</p>
                                </div>
                            </div>
                            <button class="btn btn-outline btn-full" onclick="openExerciseModal()">
                                + Add Exercises
                            </button>
                        </div>
                    </div>
                
                    <!-- Notes (shown for both modes) -->
                    <div class="form-group">
                        <label>Notes (Optional)</label>
                        <textarea id="workout-notes" class="form-control" rows="3" 
                                  placeholder="How did you feel? Any observations..."></textarea>
                    </div>
                
                    <!-- Actions -->
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-primary" onclick="saveWorkout()">
                            <span id="save-btn-text">Save Workout</span>
                        </button>
                        <button class="btn btn-outline" onclick="saveAsTemplate()" id="template-btn">
                            Save as Template
                        </button>
                    </div>
                </div>
            </div>

            <!-- Exercise Selection Modal -->
            <div id="exercise-modal" class="exercise-modal">
                <div class="exercise-modal-content">
                    <div class="exercise-modal-header">
                        <h2 style="margin-bottom: 1rem;">Add Exercises</h2>

                        <input type="text" class="exercise-search" id="exercise-search" 
                               placeholder="üîç Search exercises..." oninput="filterExercises()">

                        <div class="exercise-filters" id="exercise-filters">
                            <button class="filter-pill active" data-category="all" onclick="filterByCategory('all')">All</button>
                            <button class="filter-pill" data-category="Chest" onclick="filterByCategory('Chest')">Chest</button>
                            <button class="filter-pill" data-category="Back" onclick="filterByCategory('Back')">Back</button>
                            <button class="filter-pill" data-category="Legs" onclick="filterByCategory('Legs')">Legs</button>
                            <button class="filter-pill" data-category="Arms" onclick="filterByCategory('Arms')">Arms</button>
                            <button class="filter-pill" data-category="Shoulders" onclick="filterByCategory('Shoulders')">Shoulders</button>
                            <button class="filter-pill" data-category="Core" onclick="filterByCategory('Core')">Core</button>
                            <button class="filter-pill" data-category="Cardio" onclick="filterByCategory('Cardio')">Cardio</button>
                        </div>

                        <div class="custom-toggle">
                            <input type="checkbox" id="custom-only-toggle" onchange="filterExercises()">
                            <label for="custom-only-toggle">Show My Custom Only</label>
                        </div>
                    </div>

                    <!-- Custom Exercise Form -->
                    <div id="custom-exercise-form" class="custom-exercise-form">
                        <h3 style="margin-bottom: 1rem;">Create Custom Exercise</h3>
                        <div class="form-group">
                            <label>Exercise Name</label>
                            <input type="text" id="custom-name" class="form-control" placeholder="e.g., Cable Flyes">
                        </div>
                        <div class="grid grid-2">
                            <div class="form-group">
                                <label>Category</label>
                                <select id="custom-category" class="form-control">
                                    <option value="Chest">Chest</option>
                                    <option value="Back">Back</option>
                                    <option value="Legs">Legs</option>
                                    <option value="Arms">Arms</option>
                                    <option value="Shoulders">Shoulders</option>
                                    <option value="Core">Core</option>
                                    <option value="Cardio">Cardio</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Equipment (Optional)</label>
                                <input type="text" id="custom-equipment" class="form-control" placeholder="e.g., Cable">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Image URL (Optional)</label>
                            <input type="text" id="custom-image" class="form-control" placeholder="https://...">
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-outline" onclick="cancelCustomExercise()">Cancel</button>
                            <button class="btn btn-primary" onclick="createCustomExercise()">Create & Add</button>
                        </div>
                    </div>

                    <div class="exercise-modal-body" id="exercise-list">
                        <!-- Populated by JavaScript -->
                    </div>

                    <div class="exercise-modal-footer">
                        <button class="btn btn-outline" onclick="showCustomExerciseForm()">
                            + Create Custom Exercise
                        </button>
                        <button class="btn btn-primary" onclick="addSelectedExercises()" id="add-selected-btn">
                            Add Selected (0)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendar Page -->
            <div id="calendar" class="page">
                <h1 style="margin-bottom: 1.5rem;">Workout Calendar</h1>
                
                <div class="card">
                    <div class="card-header">
                        <button class="btn btn-outline" onclick="changeMonth(-1)">‚Üê Previous</button>
                        <h2 id="calendar-month" class="card-title">November 2024</h2>
                        <button class="btn btn-outline" onclick="changeMonth(1)">Next ‚Üí</button>
                    </div>
                    <div class="calendar" id="calendar-grid"></div>
                </div>
            </div>

            <!-- Progress Page -->
            <div id="progress" class="page">
                <h1 style="margin-bottom: 1.5rem;">Progress Tracking</h1>
                
                <div class="card">
                    <h2 class="card-title">Body Weight Trend</h2>
                    <div class="chart-container">
                        <canvas id="weight-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Workout Volume</h2>
                    <div class="chart-container">
                        <canvas id="volume-chart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">Category Frequency</h2>
                    <div class="chart-container">
                        <canvas id="category-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile" class="page">
                <h1 style="margin-bottom: 1.5rem;">Profile Settings</h1>
                
                <div class="card">
                    <h2 class="card-title">Personal Information</h2>
                    
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="profile-name" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Age</label>
                            <input type="number" id="profile-age" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Gender</label>
                            <select id="profile-gender" class="form-control">
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Unit Preference</label>
                            <select id="profile-units" class="form-control">
                                <option value="kg">Metric (kg/cm)</option>
                                <option value="lb">Imperial (lb/in)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Height (cm)</label>
                            <input type="number" id="profile-height" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Current Weight (kg)</label>
                            <input type="number" step="0.1" id="profile-weight" class="form-control">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Goal</label>
                        <textarea id="profile-goal" class="form-control" rows="3" placeholder="e.g., Lose 5kg in 3 months, Build muscle..."></textarea>
                    </div>

                    <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
                </div>

                <div class="card">
                    <h2 class="card-title">Log Weight</h2>
                    <div class="grid grid-2">
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="weight-date" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Weight (kg)</label>
                            <input type="number" step="0.1" id="weight-value" class="form-control">
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="logWeight()">Log Weight</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Workout Detail Modal -->
    <div id="workout-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-date">Workout Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let exercisesData = [];
        let workoutsData = [];
        let currentMonth = new Date();
        let exerciseCounter = 0;
        let currentUser = null;
        let allExercisesData = []; // Built-in + custom exercises
        let selectedExercises = []; // Currently selected exercises in modal
        let addedExercises = []; // Exercises added to workout
        let currentFilter = 'all';
        let existingWorkoutDate = null;
        let weightChart = null;
        let volumeChart = null;
        let categoryChart = null;

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        async function loadAllExercises() {
            allExercisesData = await apiCall('/exercises/all');
            console.log('Loaded exercises:', allExercisesData);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            // Save to user profile if logged in
            if (currentUser) {
                apiCall('/user', 'PUT', {...currentUser, theme_preference: newTheme});
            }
        }

        function toggleRestDayMode() {
            const isRestDay = document.getElementById('rest-day-toggle').checked;
            const restDayMode = document.getElementById('rest-day-mode');
            const workoutMode = document.getElementById('workout-mode');
            const templateBtn = document.getElementById('template-btn');
            const saveBtnText = document.getElementById('save-btn-text');

            if (isRestDay) {
                restDayMode.style.display = 'block';
                workoutMode.style.display = 'none';
                templateBtn.style.display = 'none';
                saveBtnText.textContent = 'Save Rest Day';
                addedExercises = [];
            } else {
                restDayMode.style.display = 'none';
                workoutMode.style.display = 'block';
                templateBtn.style.display = 'inline-block';
                saveBtnText.textContent = 'Save Workout';
            }
        }

        function updateThemeIcon(theme) {
            document.getElementById('theme-icon').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            await checkAuth();
        });

        // Auth Functions
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
            
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    showApp();
                
                    // Apply user's theme preference
                    if (data.user.theme_preference) {
                        document.documentElement.setAttribute('data-theme', data.user.theme_preference);
                        localStorage.setItem('theme', data.user.theme_preference);
                        updateThemeIcon(data.user.theme_preference);
                    }
                
                    await loadExercises();
                    await loadDashboard();
                    setupNavigation();
                    document.getElementById('workout-date').valueAsDate = new Date();
                    document.getElementById('weight-date').valueAsDate = new Date();

                    if (currentUser) {
                        await loadAllExercises();
                    }
                } else {
                    showAuth();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                showAuth();
            }
        }

        function showAuth() {
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('app-section').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-section').classList.remove('hidden');
        }

        function toggleAuthForm() {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('signup-form').classList.toggle('hidden');
            document.getElementById('error-msg').classList.remove('show');
        }

        function showError(message) {
            const el = document.getElementById('error-msg');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            try {
                console.log('Attempting login...');
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({email, password})
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (data.success) {
                    console.log('Login successful, saving token...');
                    localStorage.setItem('session_token', data.token);
                    await checkAuth();
                } else {
                    showError(data.error || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('Login failed. Please try again.');
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            
            if (!name || !email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/signup`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, email, password})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('session_token', data.token);
                    await checkAuth();
                } else {
                    showError(data.error || 'Signup failed');
                }
            } catch (error) {
                showError('Signup failed. Please try again.');
            }
        }

        async function handleLogout() {
            try {
                const token = localStorage.getItem('session_token');
                await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                localStorage.removeItem('session_token');
                currentUser = null;
                showAuth();
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        // Navigation
        function setupNavigation() {
            document.querySelectorAll('[data-page]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(e.target.dataset.page);
                });
            });
        }

        function navigateTo(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            
            document.getElementById(page).classList.add('active');
            const pageLink = document.querySelector(`[data-page="${page}"]`);
            if (pageLink) pageLink.classList.add('active');
            
            if (page === 'calendar') loadCalendar();
            if (page === 'progress') loadProgress();
            if (page === 'profile') loadProfile();
        }

        // API Calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'credentials': 'include',
                }
            };
            if (data) options.body = JSON.stringify(data);
            
            const response = await fetch(`${API_BASE}${endpoint}`, options);
            
            if (response.status === 401) {
                localStorage.removeItem('session_token');
                showAuth();
                return null;
            }
            
            return response.json();
        }

        // Load Data
        async function loadExercises() {
            exercisesData = await apiCall('/exercises');
        }

        async function loadDashboard() {
            workoutsData = await apiCall('/workouts');

            if (!workoutsData) return;

            // Total workouts (exclude rest days)
            const actualWorkouts = workoutsData.filter(w => !w.is_rest_day);
            document.getElementById('total-workouts').textContent = actualWorkouts.length;

            // This week (exclude rest days)
            const thisWeekStart = new Date();
            thisWeekStart.setDate(thisWeekStart.getDate() - 7);
            const thisWeek = actualWorkouts.filter(w => new Date(w.date) >= thisWeekStart).length;
            document.getElementById('this-week').textContent = thisWeek;

            // Streak (exclude rest days)
            let streak = 0;
            const workoutDates = [...new Set(actualWorkouts.map(w => w.date))].sort().reverse();
            let checkDate = new Date();

            for (let date of workoutDates) {
                const workoutDate = new Date(date);
                const diff = Math.floor((checkDate - workoutDate) / (1000 * 60 * 60 * 24));
                if (diff <= 1) {
                    streak++;
                    checkDate = workoutDate;
                } else {
                    break;
                }
            }
            document.getElementById('current-streak').textContent = streak;

            // Today's workout
            const today = new Date().toISOString().split('T')[0];
            const todayWorkout = workoutsData.find(w => w.date === today);
            if (todayWorkout) {
                if (todayWorkout.is_rest_day) {
                    document.getElementById('today-workout').innerHTML = `
                        <div class="exercise-item">
                            <div class="exercise-details">
                                <div class="exercise-name">Rest Day</div>
                                <div class="exercise-stats">Recovery day</div>
                            </div>
                            <span class="category-badge" style="background: #8b5cf6;">Rest</span>
                        </div>
                    `;
                } else {
                    displayTodayWorkout(todayWorkout);
                }
            }

            // Recent workouts
            displayRecentWorkouts(workoutsData.slice(0, 5));
        }

        function displayTodayWorkout(workout) {
            const html = `
                <div class="exercise-item">
                    <div class="exercise-details">
                        <div class="exercise-name">${workout.day_type}</div>
                        <div class="exercise-stats">${workout.exercises.length} exercises completed</div>
                    </div>
                    <span class="category-badge">${workout.day_type}</span>
                </div>
            `;
            document.getElementById('today-workout').innerHTML = html;
        }

        function displayRecentWorkouts(workouts) {
            if (!workouts || workouts.length === 0) {
                document.getElementById('recent-workouts').innerHTML = 
                    '<p class="loading">No workouts yet. Start tracking!</p>';
                return;
            }

            const html = workouts.map(w => {
                const badge = w.is_rest_day ? 
                    '<span class="category-badge" style="background: #8b5cf6;">Rest</span>' :
                    `<span class="category-badge">${w.day_type}</span>`;

                const details = w.is_rest_day ?
                    'Recovery day' :
                    `${w.day_type} ‚Ä¢ ${w.exercises.length} exercises`;

                return `
                    <div class="exercise-item" onclick="showWorkoutDetails('${w.date}')">
                        <div class="exercise-details">
                            <div class="exercise-name">${new Date(w.date).toLocaleDateString()}</div>
                            <div class="exercise-stats">${details}</div>
                        </div>
                        ${badge}
                    </div>
                `;
            }).join('');

            document.getElementById('recent-workouts').innerHTML = html;
        }

        // Add Workout
        function addExerciseEntry() {
            exerciseCounter++;
            const html = `
                <div class="workout-entry" id="entry-${exerciseCounter}">
                    <div class="workout-entry-header">
                        <select class="form-control" id="exercise-${exerciseCounter}" onchange="updateExerciseFields(${exerciseCounter})">
                            <option value="">Select Exercise</option>
                            ${exercisesData.map(e => `<option value="${e.id}" data-category="${e.category}">${e.name} (${e.category})</option>`).join('')}
                        </select>
                        <button class="remove-btn" onclick="removeEntry(${exerciseCounter})">Remove</button>
                    </div>
                    <div class="input-row">
                        <div class="form-group">
                            <label>Sets</label>
                            <input type="number" id="sets-${exerciseCounter}" class="form-control" placeholder="3">
                        </div>
                        <div class="form-group">
                            <label>Reps</label>
                            <input type="number" id="reps-${exerciseCounter}" class="form-control" placeholder="10">
                        </div>
                        <div class="form-group">
                            <label>Weight (kg)</label>
                            <input type="number" step="0.5" id="weight-${exerciseCounter}" class="form-control" placeholder="50">
                        </div>
                        <div class="form-group" style="display:none;" id="duration-group-${exerciseCounter}">
                            <label>Duration (min)</label>
                            <input type="number" id="duration-${exerciseCounter}" class="form-control" placeholder="20">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="notes-${exerciseCounter}" class="form-control" placeholder="Optional notes...">
                    </div>
                </div>
            `;
            document.getElementById('exercises-list').insertAdjacentHTML('beforeend', html);
        }

        function updateExerciseFields(id) {
            const select = document.getElementById(`exercise-${id}`);
            const category = select.options[select.selectedIndex]?.dataset.category;
            
            if (category === 'Cardio') {
                document.getElementById(`duration-group-${id}`).style.display = 'block';
                document.getElementById(`weight-${id}`).value = '';
                document.getElementById(`weight-${id}`).disabled = true;
            } else {
                document.getElementById(`duration-group-${id}`).style.display = 'none';
                document.getElementById(`duration-${id}`).value = '';
                document.getElementById(`weight-${id}`).disabled = false;
            }
        }

        function removeEntry(id) {
            document.getElementById(`entry-${id}`).remove();
        }

        async function saveWorkout() {
            const date = document.getElementById('workout-date').value;
            const notes = document.getElementById('workout-notes').value;
            
            const exercises = [];
            for (let i = 1; i <= exerciseCounter; i++) {
                const exerciseId = document.getElementById(`exercise-${i}`)?.value;
                if (exerciseId) {
                    exercises.push({
                        exercise_id: parseInt(exerciseId),
                        sets: parseInt(document.getElementById(`sets-${i}`).value) || 0,
                        reps: parseInt(document.getElementById(`reps-${i}`).value) || 0,
                        weight: parseFloat(document.getElementById(`weight-${i}`).value) || 0,
                        duration: parseFloat(document.getElementById(`duration-${i}`).value) || null,
                        notes: document.getElementById(`notes-${i}`).value
                    });
                }
            }
            
            if (exercises.length === 0) {
                alert('Please add at least one exercise');
                return;
            }
            
            const result = await apiCall('/workouts', 'POST', {date, notes, exercises});
            
            if (result && result.success) {
                showSuccess('Workout saved successfully!');
                document.getElementById('exercises-list').innerHTML = '';
                document.getElementById('workout-notes').value = '';
                exerciseCounter = 0;
                await loadDashboard();
            }
        }

        async function checkExistingWorkout() {
            const date = document.getElementById('workout-date').value;
            if (!date) return;

            const workout = await apiCall(`/workouts/${date}`);
            const mergeIndicator = document.getElementById('merge-indicator');

            if (workout && workout.exists) {
                existingWorkoutDate = date;
                mergeIndicator.style.display = 'flex';

                // If it's a rest day, check the toggle
                if (workout.is_rest_day) {
                    document.getElementById('rest-day-toggle').checked = true;
                    toggleRestDayMode();
                } else {
                    // Load existing exercises
                    addedExercises = workout.exercises.map(ex => ({
                        id: ex.is_custom ? `custom_${ex.exercise_id}` : ex.exercise_id,
                        name: ex.name,
                        category: ex.category,
                        equipment: ex.equipment,
                        is_custom: ex.is_custom,
                        sets: ex.sets || []
                    }));
                    renderAddedExercises();
                }

                // Load notes
                document.getElementById('workout-notes').value = workout.notes || '';
            } else {
                existingWorkoutDate = null;
                mergeIndicator.style.display = 'none';
            }
        }

        function openExerciseModal() {
            document.getElementById('exercise-modal').classList.add('active');
            selectedExercises = [];
            renderExerciseList();
            updateSelectedCount();
        }

        function closeExerciseModal() {
            const modal = document.getElementById('exercise-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            const customForm = document.getElementById('custom-exercise-form');
            if (customForm) {
                customForm.classList.remove('active');
            }
            selectedExercises = [];
            renderExerciseList();
        }

        function filterByCategory(category) {
            currentFilter = category;

            // Update active pill
            document.querySelectorAll('.filter-pill').forEach(pill => {
                pill.classList.remove('active');
                if (pill.dataset.category === category) {
                    pill.classList.add('active');
                }
            });

            renderExerciseList();
        }

        function filterExercises() {
            renderExerciseList();
        }

        function renderExerciseList() {
            const searchTerm = document.getElementById('exercise-search').value.toLowerCase();
            const customOnly = document.getElementById('custom-only-toggle').checked;

            let filtered = allExercisesData.filter(ex => {
                const matchesSearch = ex.name.toLowerCase().includes(searchTerm);
                const matchesCategory = currentFilter === 'all' || ex.category === currentFilter;
                const matchesCustom = !customOnly || ex.is_custom;
                return matchesSearch && matchesCategory && matchesCustom;
            });

            const html = filtered.map(ex => {
                const isSelected = selectedExercises.includes(String(ex.id));
                const icon = getCategoryIcon(ex.category);

                return `
                    <div class="exercise-list-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleExerciseSelection('${ex.id}')">
                        <input type="checkbox" class="exercise-checkbox" 
                               ${isSelected ? 'checked' : ''} 
                               onclick="toggleExerciseSelection('${ex.id}'); event.stopPropagation();">
                        <div class="exercise-icon">${icon}</div>
                        <div class="exercise-info">
                            <div class="exercise-info-name">
                                ${ex.name} ${ex.is_custom ? '‚≠ê' : ''}
                            </div>
                            <div class="exercise-info-details">
                                ${ex.category} ‚Ä¢ ${ex.equipment || 'No equipment'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('exercise-list').innerHTML = html || 
                '<p class="loading">No exercises found</p>';
        }

        function toggleExerciseSelection(exerciseId) {
            const idStr = String(exerciseId);
            const index = selectedExercises.indexOf(idStr);
            if (index > -1) {
                selectedExercises.splice(index, 1);
            } else {
                selectedExercises.push(idStr);
            }
            renderExerciseList();
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const btn = document.getElementById('add-selected-btn');
            btn.textContent = `Add Selected (${selectedExercises.length})`;
            btn.disabled = selectedExercises.length === 0;
        }

        function addSelectedExercises() {
            // Iterate selectedExercises (IDs) and add non-duplicates to addedExercises
            selectedExercises.forEach(selId => {
                const exercise = allExercisesData.find(ex => String(ex.id) === String(selId));
                if (!exercise) return;
            
                // Prevent duplicates by ID (exact match)
                const already = addedExercises.find(e => e.id === exercise.id);
                if (already) return;
            
                // Compute API-compatible ID (strip "custom_" if present)
                let apiId = exercise.id;
                if (typeof apiId === 'string' && apiId.startsWith('custom_')) {
                    const num = parseInt(apiId.split('_')[1]);
                    apiId = Number.isNaN(num) ? exercise.id : num;
                }
            
                // Add exercise to state with one default empty set
                addedExercises.push({
                    id: exercise.id,           // keep original id for UI/internal
                    api_id: apiId,             // integer or original id usable for the API
                    name: exercise.name,
                    category: exercise.category,
                    equipment: exercise.equipment,
                    is_custom: !!exercise.is_custom,
                    // exercise-level notes (optional); sets hold set-level notes
                    exercise_notes: '',
                    sets: [
                        { set_number: 1, reps: null, weight: null, duration: null, notes: '' }
                    ]
                });
            });
        
            // Re-render and close modal
            renderAddedExercises();
            closeExerciseModal();
        }

        function getCategoryIcon(category) {
            const icons = {
                'Chest': 'üí™',
                'Back': 'üèãÔ∏è',
                'Legs': 'ü¶µ',
                'Arms': 'üí™',
                'Shoulders': 'ü§∏',
                'Core': 'üßò',
                'Cardio': 'üèÉ',
                'Biceps': 'üí™',
                'Triceps': 'üí™'
            };
            return icons[category] || 'üí™';
        }

        function showSuccess(message) {
            const el = document.getElementById('success-msg');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // Calendar
        async function loadCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            document.getElementById('calendar-month').textContent = 
                currentMonth.toLocaleDateString('en-US', {month: 'long', year: 'numeric'});

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                html += `<div style="text-align:center;font-weight:600;padding:0.5rem;">${day}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day" style="opacity:0.3;"></div>';
            }

            const today = new Date().toISOString().split('T')[0];

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const workout = workoutsData.find(w => w.date === dateStr);
                const isToday = dateStr === today;

                let classes = 'calendar-day';
                if (workout) {
                    classes += workout.is_rest_day ? ' rest-day' : ' has-workout';
                }
                if (isToday) classes += ' today';

                html += `<div class="${classes}" onclick="showWorkoutDetails('${dateStr}')">${day}</div>`;
            }

            document.getElementById('calendar-grid').innerHTML = html;
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            loadCalendar();
        }

        function showCustomExerciseForm() {
            document.getElementById('custom-exercise-form').classList.add('active');
        }

        function cancelCustomExercise() {
            document.getElementById('custom-exercise-form').classList.remove('active');
            document.getElementById('custom-name').value = '';
            document.getElementById('custom-equipment').value = '';
            document.getElementById('custom-image').value = '';
        }

        async function createCustomExercise() {
            const name = document.getElementById('custom-name').value.trim();
            const category = document.getElementById('custom-category').value;
            const equipment = document.getElementById('custom-equipment').value.trim();
            const image_url = document.getElementById('custom-image').value.trim();

            if (!name) {
                alert('Please enter an exercise name');
                return;
            }

            const result = await apiCall('/exercises/custom', 'POST', {
                name, category, equipment, image_url
            });

            if (result && result.success) {
                // Add to exercises list
                allExercisesData.push(result.exercise);

                // Auto-select the new exercise
                selectedExercises.push(result.exercise.id);

                // Reset form
                cancelCustomExercise();

                // Refresh list
                renderExerciseList();
                updateSelectedCount();

                showSuccess('Custom exercise created!');
            } else {
                alert(result.error || 'Failed to create exercise');
            }
        }

        function showWorkoutDetails(date) {
            const workout = workoutsData.find(w => w.date === date);

            if (!workout) {
                document.getElementById('modal-date').textContent = new Date(date).toLocaleDateString();
                document.getElementById('modal-body').innerHTML = '<p>No workout logged for this day.</p>';
            } else if (workout.is_rest_day) {
                document.getElementById('modal-date').textContent = 
                    `${new Date(date).toLocaleDateString()} - Rest Day`;
                document.getElementById('modal-body').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üõå</div>
                        <h3>Rest Day</h3>
                        <p style="color: var(--text-light);">Recovery day</p>
                        ${workout.notes ? `<p style="margin-top: 1rem;"><strong>Notes:</strong> ${workout.notes}</p>` : ''}
                    </div>
                `;
            } else {
                document.getElementById('modal-date').textContent = 
                    `${new Date(date).toLocaleDateString()} - ${workout.day_type}`;

                const exercisesHtml = workout.exercises.map(ex => {
                    const setsHtml = ex.sets.map(set => {
                        const parts = [];
                        if (set.reps) parts.push(`${set.reps} reps`);
                        if (set.weight) parts.push(`${set.weight}kg`);
                        if (set.duration) parts.push(`${set.duration} min`);
                        return `<li>${parts.join(' √ó ')}${set.notes ? ` - ${set.notes}` : ''}</li>`;
                    }).join('');

                    return `
                        <div class="exercise-item">
                            <div class="exercise-details">
                                <div class="exercise-name">${ex.name}</div>
                                <div class="exercise-stats">
                                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                                        ${setsHtml}
                                    </ul>
                                    ${ex.notes ? `<i style="display: block; margin-top: 0.5rem;">${ex.notes}</i>` : ''}
                                </div>
                            </div>
                            <span class="category-badge">${ex.category}</span>
                        </div>
                    `;
                }).join('');

                document.getElementById('modal-body').innerHTML = exercisesHtml + 
                    (workout.notes ? `<p style="margin-top:1rem;"><strong>Notes:</strong> ${workout.notes}</p>` : '');
            }

            document.getElementById('workout-modal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('workout-modal').classList.remove('active');
        }

        function renderAddedExercises() {
            const container = document.getElementById('selected-exercises');

            if (addedExercises.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí™</div>
                        <p>No exercises added yet</p>
                        <p style="font-size: 0.875rem;">Click "Add Exercises" to get started</p>
                    </div>
                `;
                return;
            }

            const html = addedExercises.map((ex, exIndex) => `
                <div class="exercise-card" data-exercise-index="${exIndex}">
                    <div class="exercise-card-header">
                        <div class="exercise-card-title">
                            <span>${getCategoryIcon(ex.category)}</span>
                            <span>${ex.name}</span>
                            <span class="category-badge">${ex.category}</span>
                        </div>
                        <div class="exercise-card-actions">
                            <button class="btn btn-danger" onclick="removeExercise(${exIndex})" 
                                    style="padding: 0.5rem 1rem;">
                                Remove
                            </button>
                        </div>
                    </div>
                    <div class="exercise-card-body">
                        <div class="sets-container">
                            ${ex.sets.map((set, setIndex) => renderSetRow(exIndex, setIndex, set)).join('')}
                        </div>
                        <button class="add-set-btn" onclick="addSet(${exIndex})">
                            + Add Set
                        </button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        function renderSetRow(exIndex, setIndex, set) {
            return `
                <div class="set-row" data-set-index="${setIndex}">
                    <div class="set-number">Set ${set.set_number}</div>
                    <div class="set-inputs">
                        <div class="set-input-group">
                            <label>Reps</label>
                            <input type="number" value="${set.reps || ''}" 
                                   onchange="updateSet(${exIndex}, ${setIndex}, 'reps', this.value)"
                                   placeholder="12">
                        </div>
                        <div class="set-input-group">
                            <label>Weight (kg)</label>
                            <input type="number" step="0.5" value="${set.weight || ''}" 
                                   onchange="updateSet(${exIndex}, ${setIndex}, 'weight', this.value)"
                                   placeholder="60">
                        </div>
                        <div class="set-input-group">
                            <label>Duration (min)</label>
                            <input type="number" step="0.1" value="${set.duration || ''}" 
                                   onchange="updateSet(${exIndex}, ${setIndex}, 'duration', this.value)"
                                   placeholder="5">
                        </div>
                        <div class="set-input-group">
                            <label>Notes</label>
                            <input type="text" value="${set.notes || ''}" 
                                   onchange="updateSet(${exIndex}, ${setIndex}, 'notes', this.value)"
                                   placeholder="Optional">
                        </div>
                    </div>
                    <button class="remove-set-btn" onclick="removeSet(${exIndex}, ${setIndex})">
                        ‚úï
                    </button>
                </div>
            `;
        }

        function addSet(exIndex) {
            const exercise = addedExercises[exIndex];
            const newSetNumber = exercise.sets.length + 1;
            exercise.sets.push({
                set_number: newSetNumber,
                reps: null,
                weight: null,
                duration: null,
                notes: ''
            });
            renderAddedExercises();
        }

        function removeSet(exIndex, setIndex) {
            const exercise = addedExercises[exIndex];
            exercise.sets.splice(setIndex, 1);

            // Renumber remaining sets
            exercise.sets.forEach((set, idx) => {
                set.set_number = idx + 1;
            });

            renderAddedExercises();
        }

        function updateSet(exIndex, setIndex, field, value) {
            const exercise = addedExercises[exIndex];
            const set = exercise.sets[setIndex];

            if (field === 'notes') {
                set[field] = value;
            } else {
                set[field] = value ? parseFloat(value) : null;
            }
        }

        function removeExercise(exIndex) {
            if (confirm('Remove this exercise?')) {
                addedExercises.splice(exIndex, 1);
                renderAddedExercises();
            }
        }

        async function saveWorkout() {
            const date = document.getElementById('workout-date').value;
            const globalNotes = document.getElementById('workout-notes').value;
            const isRestDay = document.getElementById('rest-day-toggle').checked;

            if (!date) {
                alert('Please select a date');
                return;
            }
        
            if (isRestDay) {
                // Save rest day (no exercises)
                const result = await apiCall('/workouts', 'POST', {
                    date,
                    notes: globalNotes || '',
                    is_rest_day: true,
                    exercises: [],
                    existing_workout_date: existingWorkoutDate || null
                });
            
                if (result && result.success) {
                    showSuccess(result.merged ? 'Rest day updated!' : 'Rest day saved!');
                    resetWorkoutForm();
                    await loadDashboard();
                } else {
                    alert(result?.error || 'Failed to save rest day');
                }
                return;
            }
        
            if (!addedExercises || addedExercises.length === 0) {
                alert('Please add at least one exercise');
                return;
            }
        
            // Build exercises payload from addedExercises state
            const exercises = addedExercises.map(ex => {
                // Prefer stored api_id, otherwise derive from ex.id
                let exerciseIdToSend = ex.api_id !== undefined ? ex.api_id : ex.id;
                if (typeof exerciseIdToSend === 'string' && exerciseIdToSend.startsWith('custom_')) {
                    const num = parseInt(exerciseIdToSend.split('_')[1]);
                    exerciseIdToSend = Number.isNaN(num) ? exerciseIdToSend : num;
                }
            
                // Filter out empty sets (no reps/weight/duration)
                const sets = (ex.sets || []).map(s => ({
                    set_number: s.set_number,
                    reps: s.reps !== null && s.reps !== '' ? Number(s.reps) : null,
                    weight: s.weight !== null && s.weight !== '' ? Number(s.weight) : null,
                    duration: s.duration !== null && s.duration !== '' ? Number(s.duration) : null,
                    notes: s.notes || ''
                })).filter(s => s.reps !== null || s.weight !== null || s.duration !== null || (s.notes && s.notes.trim() !== ''));
            
                return {
                    exercise_id: exerciseIdToSend,
                    // exercise-level notes field preserved if present (optional)
                    notes: ex.exercise_notes || '',
                    sets
                };
            }).filter(e => e.sets && e.sets.length > 0); // ensure we only send exercises that have at least one non-empty set
        
            if (exercises.length === 0) {
                alert('Please enter at least one set with reps/weight/duration or notes for your exercises.');
                return;
            }
        
            // include existing_workout_date if merging
            const payload = {
                date,
                notes: globalNotes || '',
                is_rest_day: false,
                exercises,
                existing_workout_date: existingWorkoutDate || null
            };
        
            const result = await apiCall('/workouts', 'POST', payload);
        
            if (result && result.success) {
                const message = result.merged ? 'Exercises added to existing workout!' : 'Workout saved successfully!';
                showSuccess(message);
                resetWorkoutForm();
                await loadDashboard();
            } else {
                alert(result?.error || 'Failed to save workout');
            }
        }

        function resetWorkoutForm() {
            addedExercises = [];
            existingWorkoutDate = null;
            document.getElementById('workout-notes').value = '';
            document.getElementById('rest-day-toggle').checked = false;
            document.getElementById('merge-indicator').style.display = 'none';
            toggleRestDayMode();
            renderAddedExercises();
        }

        // Progress Charts
        async function loadProgress() {
            const weightLogs = await apiCall('/weight');
            const progressData = await apiCall('/progress');
        
            if (!weightLogs || !progressData) return;
        
            // Destroy previous charts if they exist
            try { if (weightChart) { weightChart.destroy(); weightChart = null; } } catch (e) { console.warn(e); }
            try { if (volumeChart) { volumeChart.destroy(); volumeChart = null; } } catch (e) { console.warn(e); }
            try { if (categoryChart) { categoryChart.destroy(); categoryChart = null; } } catch (e) { console.warn(e); }
        
            // Weight Chart
            const weightCtx = document.getElementById('weight-chart').getContext('2d');
            weightChart = new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: weightLogs.slice().reverse().map(w => new Date(w.date).toLocaleDateString()),
                    datasets: [{
                        label: 'Body Weight (kg)',
                        data: weightLogs.map(w => w.weight),
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: false } }
                }
            });
        
            // Volume Chart
            const volumeData = progressData.workout_stats.reduce((acc, stat) => {
                if (!acc[stat.date]) acc[stat.date] = 0;
                acc[stat.date] += stat.volume || 0;
                return acc;
            }, {});
        
            const volumeCtx = document.getElementById('volume-chart').getContext('2d');
            volumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(volumeData).map(d => new Date(d).toLocaleDateString()),
                    datasets: [{
                        label: 'Total Volume (kg)',
                        data: Object.values(volumeData),
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } }
                }
            });
        
            // Category Frequency Chart
            const categoryCtx = document.getElementById('category-chart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: progressData.category_frequency.map(c => c.category),
                    datasets: [{
                        data: progressData.category_frequency.map(c => c.frequency),
                        backgroundColor: [
                            '#6366f1', '#10b981', '#f59e0b', '#ef4444',
                            '#8b5cf6', '#ec4899', '#06b6d4'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        async function loadProfile() {
            const profile = await apiCall('/user');
            if (!profile) return;

            document.getElementById('profile-name').value = profile.name || '';
            document.getElementById('profile-age').value = profile.age || '';
            document.getElementById('profile-gender').value = profile.gender || '';
            document.getElementById('profile-height').value = profile.height || '';
            document.getElementById('profile-weight').value = profile.weight || '';
            document.getElementById('profile-goal').value = profile.goal || '';
            document.getElementById('profile-units').value = profile.unit_preference || '';
        }

        // Profile Management
        async function saveProfile() {
            const data = {
                name: document.getElementById('profile-name').value,
                age: parseInt(document.getElementById('profile-age').value),
                gender: document.getElementById('profile-gender').value,
                height: parseFloat(document.getElementById('profile-height').value),
                weight: parseFloat(document.getElementById('profile-weight').value),
                goal: document.getElementById('profile-goal').value,
                unit_preference: document.getElementById('profile-units').value,
                theme_preference: document.documentElement.getAttribute('data-theme')
            };
            
            await apiCall('/user', 'PUT', data);
            alert('Profile updated successfully!');
        }

        // Helper: updates the visible unit labels next to inputs (no HTML changes required)
        function updateProfileUnitLabels() {
            // Find label nodes relative to inputs
            const heightInput = document.getElementById('profile-height');
            const weightInput = document.getElementById('profile-weight');
        
            const heightLabel = heightInput && heightInput.parentElement.querySelector('label');
            const weightLabel = weightInput && weightInput.parentElement.querySelector('label');
        
            const unit = (document.getElementById('profile-units')?.value || 'kg').toLowerCase();
        
            if (heightLabel) {
                if (unit === 'lb') {
                    heightLabel.textContent = 'Height (in)';
                } else {
                    heightLabel.textContent = 'Height (cm)';
                }
            }
        
            if (weightLabel) {
                if (unit === 'lb') {
                    weightLabel.textContent = 'Current Weight (lb)';
                } else {
                    weightLabel.textContent = 'Current Weight (kg)';
                }
            }
        }

        // Attach listener so changes update labels immediately
        document.getElementById('profile-units')?.addEventListener('change', updateProfileUnitLabels);

        async function logWeight() {
            const date = document.getElementById('weight-date').value;
            const weight = parseFloat(document.getElementById('weight-value').value);
            
            if (!weight) {
                alert('Please enter a weight');
                return;
            }
            
            await apiCall('/weight', 'POST', {date, weight});
            alert('Weight logged successfully!');
            document.getElementById('weight-value').value = '';
        }

        // Templates
        async function saveAsTemplate() {
            if (!addedExercises || addedExercises.length === 0) {
                alert('Please add at least one exercise to save as a template');
                return;
            }
        
            const name = prompt('Enter template name:');
            if (!name || !name.trim()) return;
        
            // Build template exercises payload from addedExercises
            const exercisesForTemplate = addedExercises.map(ex => {
                let exerciseIdToSend = ex.api_id !== undefined ? ex.api_id : ex.id;
                if (typeof exerciseIdToSend === 'string' && exerciseIdToSend.startsWith('custom_')) {
                    const num = parseInt(exerciseIdToSend.split('_')[1]);
                    exerciseIdToSend = Number.isNaN(num) ? exerciseIdToSend : num;
                }
            
                // Template usually stores set structure (reps/weight/duration), keep as-is but convert to numbers/null
                const sets = (ex.sets || []).map(s => ({
                    set_number: s.set_number,
                    reps: s.reps !== null && s.reps !== '' ? Number(s.reps) : null,
                    weight: s.weight !== null && s.weight !== '' ? Number(s.weight) : null,
                    duration: s.duration !== null && s.duration !== '' ? Number(s.duration) : null
                }));
            
                return {
                    exercise_id: exerciseIdToSend,
                    name: ex.name,
                    category: ex.category,
                    sets
                };
            });
        
            const result = await apiCall('/templates', 'POST', {
                name: name.trim(),
                exercises: exercisesForTemplate
            });
        
            if (result && result.success) {
                alert('Template saved successfully!');
            } else {
                alert(result?.error || 'Failed to save template');
            }
        }

        // Close modal on outside click
        document.getElementById('workout-modal').addEventListener('click', (e) => {
            if (e.target.id === 'workout-modal') {
                closeModal();
            }
        });

        // Enter key handlers for auth forms
        document.getElementById('login-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        
        document.getElementById('signup-password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSignup();
        });
        
        // Close modal on outside click
        document.getElementById('exercise-modal')?.addEventListener('click', (e) => {
            if (e.target.id === 'exercise-modal') {
                closeExerciseModal();
            }
        });
    </script>
</body>
</html>